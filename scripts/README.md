# Build Scripts Guide

This directory contains automation scripts for building, packaging, and developing the Smart Workflow Obsidian plugin.

## Quick Start

### First-time Setup

```bash
# 1. Install dependencies
pnpm i

# 2. Build Rust binary (only needed once)
pnpm build:rust

# 3. Build and install to Obsidian
pnpm install:dev
```

### Daily Development Workflow

```bash
# After modifying code, just run (automatically executes pnpm build)
pnpm install:dev

# Then in Obsidian:
# â†’ Settings â†’ Community plugins â†’ Click "Reload" button on Smart Workflow title
```

> ðŸ’¡ **Tip**: `pnpm install:dev` includes automatic build, no need to run `pnpm build` manually

---

## Script Reference

### build-rust.js - Build Rust Binary

```bash
# Auto-detect current platform and build
node scripts/build-rust.js

# Or via pnpm
pnpm build:rust

# Skip installing build target
node scripts/build-rust.js --skip-install

# Clean build cache before building
node scripts/build-rust.js --clean
```

**Output**: `binaries/smart-workflow-server-{platform}-{arch}` and corresponding `.sha256` file

> **Note**: Local builds only support the current platform. Cross-compilation requires GitHub Actions.

---

### package-plugin.js - Package Plugin

```bash
# Auto-detect current platform and package
pnpm package

# Package and create ZIP
pnpm package -- --zip
```

**Output**: `plugin-package/`

> **Note**: Local packaging only includes the current platform binary. Full release packages are generated by GitHub Actions.

---

### install-dev.js - Development Install

âš ï¸ **Warning**: This script will OVERWRITE existing files by default!

```bash
# Standard install (auto build + install, force overwrite by default)
pnpm install:dev

# Run ESLint and TypeScript check before build
pnpm install:dev --check

# Auto-close Obsidian process (solves file lock issues)
pnpm install:dev --kill

# Skip build step (copy files only)
pnpm install:dev --no-build

# Interactive mode (ask before overwrite)
pnpm install:dev -i
pnpm install:dev --interactive

# Reset saved configuration
pnpm install:dev --reset

# Combine flags
pnpm install:dev --check --kill
```

**Workflow**:
1. Run ESLint + TypeScript check (only when `--check` is used)
2. Automatically execute `pnpm build` (unless `--no-build` is used)
3. Check required files (main.js, manifest.json, styles.css, binary files)
4. Terminate server processes to release file locks
5. Copy files to Obsidian plugins directory
6. Restart Obsidian if `--kill` was used
7. First run prompts for plugins directory path, then remembers it

**After Install**: In Obsidian Settings â†’ Community plugins â†’ Click "Reload" button on Smart Workflow title

---

## Release Process

**Recommended: Use GitHub Actions for automated releases**:

```bash
# 1. Update version numbers (manifest.json and versions.json)

# 2. Commit and create tag
git add .
git commit -m "chore: bump version to x.x.x"
git tag vx.x.x
git push origin vx.x.x

# 3. GitHub Actions will automatically:
#    - Build binaries for all platforms (win32-x64, darwin-arm64, darwin-x64, linux-x64, linux-arm64)
#    - Package the plugin
#    - Create GitHub Release (with full package and platform-specific packages)
```

No local cross-compilation needed, no manual artifact uploads required.

---

## FAQ

### Missing Binary Files

Running `pnpm install:dev` shows missing `binaries/smart-workflow-server-*` files.

**Solution**:
```bash
pnpm build:rust
```

This command automatically detects your current platform and builds the corresponding binary, no need to specify platform parameters.

### Files Locked and Cannot Be Copied

Obsidian is using the server binary file.

> ðŸ’¡ **Tip**: `pnpm install:dev` automatically terminates server processes to release file locks, usually no manual action needed.

If you still encounter file lock issues:
```bash
# Use --kill flag to auto-close Obsidian
pnpm install:dev --kill
```

### Reset Plugin Directory Configuration

Entered wrong plugin directory path on first run.

**Solution**:
```bash
pnpm install:dev --reset
```

---

## Related Documentation

- [Rust Server Documentation](../rust-servers/README.md)
- [Main README](../README.md)
- [GitHub Actions Workflow](../.github/workflows/release.yml)
